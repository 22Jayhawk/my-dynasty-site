import streamlit as st
import pandas as pd
import requests

# --- CONFIG ---
LEAGUE_ID = "1312559657998368768"

st.set_page_config(page_title="Dynasty Hub", layout="wide")

# --- DATA FETCHING ---
@st.cache_data(ttl=3600)
def get_sleeper(endpoint):
    return requests.get(f"https://api.sleeper.app/v1/league/{LEAGUE_ID}/{endpoint}").json()

# --- APP LAYOUT ---
st.title("ğŸ† The Dynasty Command Center")

tab1, tab2, tab3 = st.tabs(["ğŸ“Š Standings", "ğŸ“œ League History", "âš–ï¸ Constitution"])

with tab1:
    st.header("Live Sleeper Standings")
    users = {u['user_id']: u['display_name'] for u in get_sleeper("users")}
    rosters = get_sleeper("rosters")
    
    data = []
    for r in rosters:
        data.append({
            "Manager": users.get(r['owner_id'], "Unknown"),
            "W-L": f"{r['settings']['wins']}-{r['settings']['losses']}",
            "Points For": r['settings']['fpts'] + (r['settings']['fpts_decimal'] / 100),
            "Max PF": r['settings'].get('ppts', 0)
        })
    st.table(pd.DataFrame(data).sort_values("Points For", ascending=False))

with tab2:
    st.header("Historical Records")
    try:
        df = pd.read_excel("league_data.xlsx")
        st.dataframe(df, use_container_width=True)
    except:
        st.warning("Upload 'league_data.xlsx' to see your history here!")

with tab3:
    st.header("League Rules")
    st.write("Current rules are managed in your Excel file.")